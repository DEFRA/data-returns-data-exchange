<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<preConditions>
		<dbms type="postgresql"/>
		<runningAs username="data_returns_owner"/>
	</preConditions>

	<changeSet id="create-permit-id-sequence" author="aharrison">
		<createSequence sequenceName="seq_permit_id" incrementBy="1" startValue="1"/>
		<rollback>DROP SEQUENCE seq_permit_id</rollback>
	</changeSet>

	<changeSet id="create-permit-table" author="aharrison">
		<createTable tableName="permit" tablespace="dr_data">
			<column name="id" type="int" defaultValue="nextval('data_returns_schema.seq_permit_id')">
				<constraints primaryKeyName="pk_permit_id" primaryKey="true" nullable="false"/>
			</column>
			<column name="permit_number" type="varchar(10)">	<!-- TODO guessed big enough, looks like could reduce to 8? -->
				<constraints nullable="false"/>
			</column>
		</createTable>
		<rollback>DROP TABLE permit</rollback>
	</changeSet>

	<!-- START - Load environment specific data (keep separate for now as may differ) -->
	
	<!-- TODO pass in file location -->
	<changeSet id="load-dev-permit-data" author="aharrison" context="dev">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="0">select count(id) from permit</sqlCheck>
		</preConditions>
		<loadData file="./src/main/resources/db/data/permits_dev.csv" tableName="permit"/>
		<rollback>DELETE * FROM permit</rollback>
	</changeSet>

	<changeSet id="load-test-permit-data" author="aharrison" context="test">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="0">select count(id) from permit</sqlCheck>
		</preConditions>
		<loadData file="./src/main/resources/db/data/permits_test.csv" tableName="permit"/>
		<rollback>DELETE * FROM permit</rollback>
	</changeSet>

	<changeSet id="load-prod-permit-data" author="aharrison" context="prod">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="0">select count(id) from permit</sqlCheck>
		</preConditions>
		<loadData file="./src/main/resources/db/data/permits_prod.csv" tableName="permit"/>
		<rollback>DELETE * FROM permit</rollback>
	</changeSet>
	
	<!-- END - Load environment specific data -->

	<changeSet id="create-permit-id-index" author="aharrison">
		<createIndex indexName="idx_permit_number" tableName="permit" unique="true" tablespace="dr_index">
			<column name="permit_number" type="varchar(10)"/>	<!-- TODO guessed big enough, looks like could reduce to 8? -->
		</createIndex>
		<rollback>DROP INDEX idx_permit_number</rollback>
	</changeSet>

</databaseChangeLog>
