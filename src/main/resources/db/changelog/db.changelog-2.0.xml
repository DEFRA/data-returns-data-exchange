<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
				   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

	<preConditions>
		<dbms type="${db.type}"/>
		<runningAs username="${db.username}"/>
	</preConditions>

	<changeSet id="user data" author="Environment Agency">
		<!--
		  ****************************************************************
		  User
		  ****************************************************************
		  -->
		<createTable tableName="md_users">
			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="identifier" type="varchar(80)">
				<constraints nullable="false"/>
			</column>

			<column name="create_date" type="timestamp without timezone">
				<constraints nullable="false"/>
			</column>

			<column name="last_changed_date" type="timestamp without timezone">
				<constraints nullable="false"/>
			</column>

			<column name="dataset_changed_date" type="timestamp without timezone">
				<constraints nullable="true"/>
			</column>

		</createTable>

		<createIndex indexName="idx_md_users_identifier" tableName="md_users" unique="true">
			<column name="identifier"/>
		</createIndex>

		<sql>insert into md_users (identifier, create_date, last_changed_date, dataset_changed_date) values ('SYSTEM', current_timestamp,
			current_timestamp, current_timestamp)
		</sql>

		<!--
		****************************************************************
		DatasetEntity
		****************************************************************
		-->
		<createTable tableName="ud_datasets">
			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="user_id" type="bigint">
				<constraints nullable="false"/>
			</column>

			<column name="identifier" type="varchar(80)">
				<constraints nullable="false"/>
			</column>

			<column name="status" type="varchar(11)">
				<constraints nullable="false"/>
			</column>

			<column name="originator_email" type="varchar(500)">
				<constraints nullable="true"/>
			</column>

			<column name="create_date" type="timestamp without timezone">
				<constraints nullable="false"/>
			</column>

			<column name="last_changed_date" type="timestamp without timezone">
				<constraints nullable="false"/>
			</column>

			<column name="record_changed_date" type="timestamp without timezone">
				<constraints nullable="true"/>
			</column>

		</createTable>

		<createIndex indexName="idx_ud_datasets" tableName="ud_datasets" unique="true">
			<column name="user_id"/>
			<column name="identifier"/>
		</createIndex>

		<addForeignKeyConstraint baseColumnNames="user_id"
								 baseTableName="ud_datasets"
								 constraintName="fk_ud_datasets_user"
								 referencedColumnNames="id"
								 referencedTableName="md_users"/>


		<!--
		****************************************************************
		Records
		****************************************************************
		-->
		<createTable tableName="ud_records">

			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="dataset_id" type="bigint">
				<constraints nullable="false"/>
			</column>

			<column name="identifier" type="varchar(80)">
				<constraints nullable="false"/>
			</column>

			<column name="status" type="varchar(10)">
				<constraints nullable="false"/>
			</column>

			<column name="payload_type" type="varchar(100)">
				<constraints nullable="true"/>
			</column>

			<column name="create_date" type="timestamp without timezone">
				<constraints nullable="false"/>
			</column>

			<column name="last_changed_date" type="timestamp without timezone">
				<constraints nullable="false"/>
			</column>

			<column name="json" type="varchar(16000)">
				<constraints nullable="true"/>
			</column>

		</createTable>

		<createIndex indexName="idx_ud_records" tableName="ud_records" unique="true">
			<column name="dataset_id"/>
			<column name="identifier"/>
		</createIndex>

		<addForeignKeyConstraint baseColumnNames="dataset_id"
								 baseTableName="ud_records"
								 constraintName="fk_record_dataset"
								 referencedColumnNames="id"
								 referencedTableName="ud_datasets"/>


		<!--
		****************************************************************
		Payload types
		****************************************************************
		-->
		<createTable tableName="md_payload_types">
			<column name="payload_type" type="varchar(100)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="create_date" type="timestamp without timezone" defaultValueComputed="current_timestamp">
				<constraints nullable="false"/>
			</column>

			<column name="last_changed_date" type="timestamp without timezone" defaultValueComputed="current_timestamp">
				<constraints nullable="false"/>
			</column>

		</createTable>

		<loadData file="/db/data/PayloadTypes.csv" tableName="md_payload_types"/>

		<!--
		****************************************************************
		Fields
		****************************************************************
		-->
		<createTable tableName="md_fields">

			<column name="payload_type" type="varchar(100)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="field_name" type="varchar(100)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="description" type="varchar(500)"/>

			<column name="create_date" type="timestamp without timezone" defaultValueComputed="current_timestamp">
				<constraints nullable="false"/>
			</column>

			<column name="last_changed_date" type="timestamp without timezone" defaultValueComputed="current_timestamp">
				<constraints nullable="false"/>
			</column>

		</createTable>

		<loadData file="/db/data/Fields.csv" tableName="md_fields"/>

		<addForeignKeyConstraint baseColumnNames="payload_type"
								 baseTableName="md_fields"
								 constraintName="fk_md_fields_payload"
								 referencedColumnNames="payload_type"
								 referencedTableName="md_payload_types"/>

		<!--
		****************************************************************
		Validation errors
		****************************************************************
		-->
		<createTable tableName="md_validation_errors">
			<column name="payload_type" type="varchar(100)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="error" type="varchar(20)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="message" type="varchar(300)"/>

			<column name="create_date" type="timestamp without timezone" defaultValueComputed="current_timestamp">
				<constraints nullable="false"/>
			</column>

			<column name="last_changed_date" type="timestamp without timezone" defaultValueComputed="current_timestamp">
				<constraints nullable="false"/>
			</column>

		</createTable>

		<loadData file="/db/data/ValidationErrors.csv" tableName="md_validation_errors"/>

		<addForeignKeyConstraint baseColumnNames="payload_type"
								 baseTableName="md_validation_errors"
								 constraintName="fk_md_validation_errors_payload"
								 referencedColumnNames="payload_type"
								 referencedTableName="md_payload_types"/>

		<!--
		****************************************************************
		Validation error fields
		****************************************************************
		-->
		<createTable tableName="md_validation_error_fields">

			<column name="payload_type" type="varchar(100)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="error" type="varchar(20)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="field_name" type="varchar(100)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

		</createTable>

		<addForeignKeyConstraint baseColumnNames="payload_type, error"
								 baseTableName="md_validation_error_fields"
								 constraintName="fk_md_validation_error_fields_validation_error"
								 referencedColumnNames="payload_type, error"
								 referencedTableName="md_validation_errors"/>

		<addForeignKeyConstraint baseColumnNames="payload_type, field_name"
								 baseTableName="md_validation_error_fields"
								 constraintName="fk_md_validation_error_fields_fields"
								 referencedColumnNames="payload_type, field_name"
								 referencedTableName="md_fields"/>

		<loadData file="/db/data/ValidationErrorFields.csv" tableName="md_validation_error_fields"/>

		<!--
		****************************************************************
		Record validation errors
		****************************************************************
		-->
		<createTable tableName="ud_record_validation_errors">

			<column name="record_id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="payload_type" type="varchar(100)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="error" type="varchar(20)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

		</createTable>

		<addForeignKeyConstraint baseColumnNames="record_id"
								 baseTableName="ud_record_validation_errors"
								 constraintName="fk_ud_record_validation_errors_records"
								 referencedColumnNames="id"
								 referencedTableName="ud_records"/>

		<addForeignKeyConstraint baseColumnNames="payload_type, error"
								 baseTableName="ud_record_validation_errors"
								 constraintName="fk_ud_record_validation_errors_payload"
								 referencedColumnNames="payload_type, error"
								 referencedTableName="md_validation_errors"/>

		<!--
		****************************************************************
		Data Sample
		****************************************************************
		-->
		<createTable tableName="ud_data_sample">

			<column name="dataset_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="record_id" type="bigserial">
				<constraints nullable="false"/>
			</column>

			<column name="ea_id" type="bigint">
				<constraints nullable="false"/>
			</column>

			<column name="return_type_id" type="bigint">
				<constraints nullable="false"/>
			</column>

			<column name="mon_date" type="timestamp">
				<constraints nullable="false"/>
			</column>

			<column name="mon_point" type="varchar(50)">
				<constraints nullable="false"/>
			</column>

			<column name="parameter_id" type="bigint">
				<constraints nullable="false"/>
			</column>

			<column name="numeric_value" type="decimal">
				<constraints nullable="true"/>
			</column>

			<column name="numeric_value_text" type="varchar(20)">
				<constraints nullable="true"/>
			</column>

			<column name="text_value_id" type="bigint">
				<constraints nullable="true"/>
			</column>

			<column name="qualifier_id" type="bigint">
				<constraints nullable="true"/>
			</column>

			<column name="unit_id" type="bigint">
				<constraints nullable="true"/>
			</column>

			<column name="reference_period_id" type="bigint">
				<constraints nullable="true"/>
			</column>

			<column name="method_or_standard_id" type="bigint">
				<constraints nullable="true"/>
			</column>

			<column name="return_period" type="varchar(255)">
				<constraints nullable="true"/>
			</column>

			<column name="comments" type="varchar(255)">
				<constraints nullable="true"/>
			</column>

		</createTable>

		<createIndex indexName="idx_ud_data_sample" tableName="ud_data_sample" unique="true">
			<column name="dataset_id"/>
			<column name="record_id"/>
		</createIndex>

		<addForeignKeyConstraint baseColumnNames="dataset_id"
								 baseTableName="ud_data_sample"
								 constraintName="fk_ud_data_sample_dataset"
								 referencedColumnNames="id"
								 referencedTableName="ud_datasets"/>

		<addForeignKeyConstraint baseColumnNames="record_id"
								 baseTableName="ud_data_sample"
								 constraintName="fk_ud_data_sample_record"
								 referencedColumnNames="id"
								 referencedTableName="ud_records"/>

		<addForeignKeyConstraint baseColumnNames="ea_id"
								 baseTableName="ud_data_sample"
								 constraintName="fk_ud_data_sample_unique_identifier"
								 referencedColumnNames="id"
								 referencedTableName="md_unique_identifiers"/>

		<addForeignKeyConstraint baseColumnNames="return_type_id"
								 baseTableName="ud_data_sample"
								 constraintName="fk_ud_data_sample_return_type"
								 referencedColumnNames="id"
								 referencedTableName="md_return_types"/>

		<addForeignKeyConstraint baseColumnNames="parameter_id"
								 baseTableName="ud_data_sample"
								 constraintName="fk_ud_data_sample_parameter"
								 referencedColumnNames="id"
								 referencedTableName="md_parameters"/>

		<addForeignKeyConstraint baseColumnNames="text_value_id"
								 baseTableName="ud_data_sample"
								 constraintName="fk_ud_data_sample_text_value"
								 referencedColumnNames="id"
								 referencedTableName="md_text_values"/>

		<addForeignKeyConstraint baseColumnNames="qualifier_id"
								 baseTableName="ud_data_sample"
								 constraintName="fk_ud_data_sample_qualifier"
								 referencedColumnNames="id"
								 referencedTableName="md_qualifiers"/>

		<addForeignKeyConstraint baseColumnNames="unit_id"
								 baseTableName="ud_data_sample"
								 constraintName="fk_ud_data_sample_unit"
								 referencedColumnNames="id"
								 referencedTableName="md_units"/>

		<addForeignKeyConstraint baseColumnNames="reference_period_id"
								 baseTableName="ud_data_sample"
								 constraintName="fk_ud_data_sample_reference_period"
								 referencedColumnNames="id"
								 referencedTableName="md_reference_periods"/>

		<addForeignKeyConstraint baseColumnNames="method_or_standard_id"
								 baseTableName="ud_data_sample"
								 constraintName="fk_ud_data_sample_method_or_standard"
								 referencedColumnNames="id"
								 referencedTableName="md_methods_or_standards"/>

		<!--
		****************************************************************
		Alternative payload - prototype
		****************************************************************
		-->
		<createTable tableName="ud_alternatives">
			<column name="dataset_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="record_id" type="bigserial">
				<constraints nullable="false"/>
			</column>

			<column name="test" type="varchar(100)"/>
		</createTable>

		<addForeignKeyConstraint baseColumnNames="dataset_id"
								 baseTableName="ud_alternatives"
								 constraintName="fk_ud_alternatives_dataset"
								 referencedColumnNames="id"
								 referencedTableName="ud_datasets"/>
		<addForeignKeyConstraint baseColumnNames="record_id"
								 baseTableName="ud_alternatives"
								 constraintName="fk_ud_alternatives_record"
								 referencedColumnNames="id"
								 referencedTableName="ud_records"/>

		<!--
		****************************************************************
		Rollback
		****************************************************************
		-->

		<rollback>
			<dropTable tableName="ud_record_validation_error_fields"/>
			<dropTable tableName="ud_record_validation_errors"/>
			<dropTable tableName="md_validation_errors"/>
			<dropTable tableName="md_fields"/>
			<dropTable tableName="md_payload_types"/>
			<dropTable tableName="ud_alternatives"/>
			<dropTable tableName="ud_data_sample"/>
			<dropTable tableName="ud_records"/>
			<dropTable tableName="ud_datasets"/>
			<dropTable tableName="md_users"/>
		</rollback>

	</changeSet>

</databaseChangeLog>