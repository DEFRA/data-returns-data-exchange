<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

	<preConditions>
		<dbms type="${db.type}"/>
		<runningAs username="${db.username}"/>
	</preConditions>

	<changeSet id="user data" author="Environment Agency">
	  <!--
		****************************************************************
		User
		****************************************************************
		-->
		<createTable tableName="users">
			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="identifier" type="varchar(80)">
				<constraints nullable="false"/>
			</column>

			<column name="create_date" type="timestamp without timezone">
				<constraints nullable="false"/>
			</column>

			<column name="last_changed_date" type="timestamp without timezone">
				<constraints nullable="false"/>
			</column>
		</createTable>

		<createIndex indexName="idx_user_identifier" tableName="users" unique="true">
			<column name="identifier"/>
		</createIndex>

		<sql>insert into users (identifier, create_date, last_changed_date) values ('SYSTEM', current_timestamp, current_timestamp)</sql>

		<!--
		****************************************************************
		DatasetEntity
		****************************************************************
		-->
		<createTable tableName="datasets">

			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="user_id" type="bigint">
				<constraints nullable="false"/>
			</column>

			<column name="identifier" type="varchar(80)">
				<constraints nullable="false"/>
			</column>

			<column name="originator_email" type="varchar(500)">
				<constraints nullable="true"/>
			</column>

			<column name="create_date" type="timestamp without timezone">
				<constraints nullable="false"/>
			</column>

			<column name="last_changed_date" type="timestamp without timezone">
				<constraints nullable="false"/>
			</column>

		</createTable>

		<createIndex indexName="idx_datasets" tableName="datasets" unique="true">
			<column name="user_id"/>
			<column name="identifier"/>
		</createIndex>

		<addForeignKeyConstraint baseColumnNames="user_id"
								 baseTableName="datasets"
								 constraintName="fk_dataset_user"
								 referencedColumnNames="id"
								 referencedTableName="users"/>


		<!--
		****************************************************************
		Records
		****************************************************************
		-->
		<createTable tableName="records">

			<column name="id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="dataset_id" type="bigint">
				<constraints nullable="false"/>
			</column>

			<column name="identifier" type="varchar(80)">
				<constraints nullable="false"/>
			</column>

			<column name="status" type="varchar(10)">
				<constraints nullable="false"/>
			</column>

			<column name="create_date" type="timestamp without timezone">
				<constraints nullable="false"/>
			</column>

			<column name="last_changed_date" type="timestamp without timezone">
				<constraints nullable="false"/>
			</column>

			<column name="json" type="varchar(16000)">
				<constraints nullable="true"/>
			</column>

		</createTable>

		<createIndex indexName="idx_records" tableName="records" unique="true">
			<column name="dataset_id"/>
			<column name="identifier"/>
		</createIndex>

		<addForeignKeyConstraint baseColumnNames="dataset_id"
								 baseTableName="records"
								 constraintName="fk_record_dataset"
								 referencedColumnNames="id"
								 referencedTableName="datasets"/>


		<!--
		****************************************************************
		Payload types
		****************************************************************
		-->
		<createTable tableName="payload_types">
			<column name="payload_type" type="varchar(100)">
				<constraints primaryKey="true" nullable="false"/>
			</column>
		</createTable>

		<loadData file="/db/data/PayloadTypes.csv" tableName="payload_types"/>

		<!--
		****************************************************************
		Fields
		****************************************************************
		-->
		<createTable tableName="fields">
			<column name="payload_type" type="varchar(100)">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="field_name" type="varchar(100)">
				<constraints primaryKey="true" nullable="false"/>
			</column>
		</createTable>

		<loadData file="/db/data/Fields.csv" tableName="payload_types"/>

		<addForeignKeyConstraint baseColumnNames="payload_type"
														 baseTableName="fields"
														 constraintName="fk_fields_payload"
														 referencedColumnNames="payload_type"
														 referencedTableName="payload_types"/>

		<!--
		****************************************************************
		Validation errors
		****************************************************************
		-->
		<createTable tableName="validation_errors">
			<column name="payload_type" type="varchar(100)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="error" type="varchar(20)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="message" type="varchar(300)"/>
		</createTable>

		<loadData file="/db/data/ValidationErrors.csv" tableName="validation_errors"/>

		<addForeignKeyConstraint baseColumnNames="payload_type"
														 baseTableName="validation_errors"
														 constraintName="fk_validation_errors_payload"
														 referencedColumnNames="payload_type"
														 referencedTableName="payload_types"/>


		<!--
		****************************************************************
		Validation errors fields
		****************************************************************
		-->
		<createTable tableName="validation_error_fields">

			<column name="payload_type" type="varchar(100)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="error" type="varchar(20)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="field" type="varchar(20)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

		</createTable>

		<addForeignKeyConstraint baseColumnNames="payload_type"
														 baseTableName="validation_error_fields"
														 constraintName="fk_validation_error_fields_payload"
														 referencedColumnNames="payload_type"
														 referencedTableName="payload_types"/>

		<loadData file="/db/data/ValidationErrorFields.csv" tableName="validation_error_fields"/>

		<!--
		****************************************************************
		Record validation errors
		****************************************************************
		-->
		<createTable tableName="record_validation_errors">

			<column name="record_id" type="bigserial">
				<constraints primaryKey="true" nullable="false"/>
			</column>

			<column name="error" type="varchar(20)">
				<constraints primaryKey="true" nullable="false"/>
			</column>

		</createTable>

		<addForeignKeyConstraint baseColumnNames="record_id"
														 baseTableName="record_validation_errors"
														 constraintName="fk_record_validation_errors_records"
														 referencedColumnNames="id"
														 referencedTableName="records"/>

		<addForeignKeyConstraint baseColumnNames="error"
														 baseTableName="record_validation_errors"
														 constraintName="fk_record_validation_errors_errors"
														 referencedColumnNames="error"
														 referencedTableName="validation_errors"/>

		<!--
		****************************************************************
		Data Sample
		****************************************************************
		-->
		<createTable tableName="data_sample">

			<column name="record_id" type="bigserial">
				<constraints nullable="false"/>
			</column>

			<column name="ea_id" type="bigint">
				<constraints nullable="false"/>
			</column>

			<column name="site_id" type="bigint">
				<constraints nullable="false"/>
			</column>

			<column name="return_type_id" type="bigint">
				<constraints nullable="false"/>
			</column>

			<column name="mon_date" type="timestamp">
				<constraints nullable="false"/>
			</column>

			<column name="mon_point" type="varchar(50)">
				<constraints nullable="false"/>
			</column>

			<column name="parameter_id" type="bigint">
				<constraints nullable="false"/>
			</column>

			<column name="numeric_value" type="decimal">
				<constraints nullable="true"/>
			</column>

			<column name="numeric_value_text" type="varchar(20)">
				<constraints nullable="true"/>
			</column>

			<column name="text_value_id" type="bigint">
				<constraints nullable="true"/>
			</column>

			<column name="qualifier_id" type="bigint">
				<constraints nullable="true"/>
			</column>

			<column name="unit_id" type="bigint">
				<constraints nullable="true"/>
			</column>

			<column name="reference_period_id" type="bigint">
				<constraints nullable="true"/>
			</column>

			<column name="method_or_standard_id" type="bigint">
				<constraints nullable="true"/>
			</column>

			<column name="comments" type="varchar(255)">
				<constraints nullable="true"/>
			</column>

		</createTable>

		<createIndex indexName="idx_data_sample" tableName="data_sample" unique="true">
			<column name="record_id"/>
		</createIndex>

		<addForeignKeyConstraint baseColumnNames="record_id"
								 baseTableName="data_sample"
								 constraintName="fk_data_sample_record"
								 referencedColumnNames="id"
								 referencedTableName="records"/>

		<addForeignKeyConstraint baseColumnNames="ea_id"
								 baseTableName="data_sample"
								 constraintName="fk_data_sample_unique_identifier"
								 referencedColumnNames="id"
								 referencedTableName="unique_identifiers"/>

		<addForeignKeyConstraint baseColumnNames="site_id"
								 baseTableName="data_sample"
								 constraintName="fk_data_sample_site"
								 referencedColumnNames="id"
								 referencedTableName="sites"/>

		<addForeignKeyConstraint baseColumnNames="return_type_id"
								 baseTableName="data_sample"
								 constraintName="fk_data_sample_return_type"
								 referencedColumnNames="id"
								 referencedTableName="return_types"/>

		<addForeignKeyConstraint baseColumnNames="parameter_id"
								 baseTableName="data_sample"
								 constraintName="fk_data_sample_parameter"
								 referencedColumnNames="id"
								 referencedTableName="parameters"/>

		<addForeignKeyConstraint baseColumnNames="text_value_id"
								 baseTableName="data_sample"
								 constraintName="fk_data_sample_text_value"
								 referencedColumnNames="id"
								 referencedTableName="text_values"/>

		<addForeignKeyConstraint baseColumnNames="qualifier_id"
								 baseTableName="data_sample"
								 constraintName="fk_data_sample_qualifier"
								 referencedColumnNames="id"
								 referencedTableName="qualifiers"/>

		<addForeignKeyConstraint baseColumnNames="unit_id"
								 baseTableName="data_sample"
								 constraintName="fk_data_sample_unit"
								 referencedColumnNames="id"
								 referencedTableName="units"/>

		<addForeignKeyConstraint baseColumnNames="reference_period_id"
								 baseTableName="data_sample"
								 constraintName="fk_data_sample_reference_period"
								 referencedColumnNames="id"
								 referencedTableName="reference_periods"/>

		<addForeignKeyConstraint baseColumnNames="method_or_standard_id"
								 baseTableName="data_sample"
								 constraintName="fk_data_sample_method_or_standard"
								 referencedColumnNames="id"
								 referencedTableName="methods_or_standards"/>

		<!--
		****************************************************************
		Alternative payload - prototype
		****************************************************************
		-->
		<createTable tableName="alternatives">
			<column name="record_id" type="bigserial">
				<constraints nullable="false"/>
			</column>

			<column name="test" type="varchar(100)"/>
		</createTable>

		<addForeignKeyConstraint baseColumnNames="record_id"
								 baseTableName="alternatives"
								 constraintName="fk_alternatives_record"
								 referencedColumnNames="id"
								 referencedTableName="records"/>

		<!--
		****************************************************************
		Rollback
		****************************************************************
		-->

		<rollback>
			<dropTable tableName="record_validation_error_fields"/>
			<dropTable tableName="record_validation_errors"/>
			<dropTable tableName="validation_errors"/>
			<dropTable tableName="alternatives"/>
			<dropTable tableName="data_sample"/>
			<dropTable tableName="status"/>
			<dropTable tableName="records"/>
			<dropTable tableName="datasets"/>
			<dropTable tableName="users"/>
		</rollback>

	</changeSet>

</databaseChangeLog>